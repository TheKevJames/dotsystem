#!/usr/bin/env bash
set -euo pipefail

declare -A REPOS
declare -A SOURCES

SOURCES=()
SOURCES["root/~/.config/zsh/plugins/_extract"]="plugins/extract/_extract"  # TODO: add *.epub (unzip)
SOURCES["root/~/.config/zsh/plugins/completion.zsh"]="lib/completion.zsh"
SOURCES["root/~/.config/zsh/plugins/extract.plugin.zsh"]="plugins/extract/extract.plugin.zsh"
SOURCES["root/~/.config/zsh/plugins/shrink-path.plugin.zsh"]="plugins/shrink-path/shrink-path.plugin.zsh"
REPOS["ohmyzsh/ohmyzsh"]=$(declare -p SOURCES)

SOURCES=()
SOURCES["root/~/.config/zsh/plugins/async-git-prompt.plugin.zsh"]="async-git-prompt.plugin.zsh"
REPOS["pawel-slowik/zsh-async-git-prompt"]=$(declare -p SOURCES)

# TODO: consider the following
# https://github.com/telagod/oh-pi/blob/main/pi-package/extensions/bg-process.ts
# TODO: vendor the skills (context7, debug-helper, git-workflow, web-fetch, web-search) without breaking markdown
SOURCES=()
SOURCES["root/~/.config/pi/extensions/auto-session-name.ts"]="pi-package/extensions/auto-session-name.ts"
SOURCES["root/~/.config/pi/extensions/compact-header.ts"]="pi-package/extensions/compact-header.ts"
SOURCES["root/~/.config/pi/extensions/custom-footer.ts"]="pi-package/extensions/custom-footer.ts"
SOURCES["root/~/.config/pi/extensions/git-guard.ts"]="pi-package/extensions/git-guard.ts"
SOURCES["root/~/.config/pi/extensions/smart-compact.ts"]="pi-package/extensions/smart-compact.ts"
REPOS["telagod/oh-pi"]=$(declare -p SOURCES)

for repo in "${!REPOS[@]}"; do
    [ "${repo}" == "telagod/oh-pi" ] && branch="main" || branch="master"
    SHA=$(gh api "repos/${repo}/commits/${branch}" -q '.sha')

    eval "${REPOS["${repo}"]}"
    for fname in "${!SOURCES[@]}"; do
        echo "Updating ${fname} from ${repo}..."
        [ "${fname##*.}" == "ts" ] && cc="//" || cc="#"
        {
            echo "${cc} This file is vendored, run ./vendor to update it."
            echo "${cc} Last Update: $(date +'%Y-%m-%d')"
            echo "${cc} Commit Hash: ${SHA}"
            echo "${cc}"
        } > "${fname}"
        curl -s "https://raw.githubusercontent.com/${repo}/${SHA}/${SOURCES[${fname}]}" >> "${fname}"

        # TODO: would be great to do this via override file
        if [[ "${fname}" == "root/~/.config/zsh/plugins/async-git-prompt.plugin.zsh" ]]; then
            sed -i~ 's#^GIT_PROMPT_FIFO_DIR=.*#GIT_PROMPT_FIFO_DIR="/tmp/zsh-git-prompt"#' "${fname}"
            rm -f "${fname}~"
        fi
    done
done
